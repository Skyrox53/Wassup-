<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wassup - Chat en temps rÃ©el</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      query,
      orderByChild,
      limitToLast,
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtPmHLghASSnVph2g6YHL5QrIt26DsNlY",
      authDomain: "wassup-b0623.firebaseapp.com",
      databaseURL: "https://wassup-b0623-default-rtdb.firebaseio.com",
      projectId: "wassup-b0623",
      storageBucket: "wassup-b0623.appspot.com",
      messagingSenderId: "967978006384",
      appId: "1:967978006384:web:55b3159139fd729f2741b5",
      measurementId: "G-MFW02K6J1L",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const messagesRef = ref(database, "messages");
    const sortedMessagesRef = query(messagesRef, orderByChild("timestamp"), limitToLast(50));

    document.addEventListener("DOMContentLoaded", () => {
      const chatBox = document.getElementById("chatBox");
      const messageInput = document.getElementById("message");
      const sendBtn = document.getElementById("sendBtn");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const userInfo = document.getElementById("userInfo");

      let currentUser = null;

      loginBtn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          currentUser = result.user;
          userInfo.textContent = `ConnectÃ© en tant que ${currentUser.displayName}`;
          logoutBtn.style.display = "inline-block";
          loginBtn.style.display = "none";
          messageInput.disabled = false;
          sendBtn.disabled = false;
        } catch (error) {
          alert("Erreur de connexion : " + error.message);
          console.error("Erreur Firebase Google Sign-In:", error);
        }
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          currentUser = null;
          userInfo.textContent = "Non connectÃ©";
          logoutBtn.style.display = "none";
          loginBtn.style.display = "inline-block";
          messageInput.disabled = true;
          sendBtn.disabled = true;
          messageInput.value = "";
        } catch (error) {
          alert("Erreur lors de la dÃ©connexion : " + error.message);
        }
      });

      sendBtn.addEventListener("click", () => {
        const message = messageInput.value.trim();
        if (currentUser && message) {
          push(messagesRef, {
            user: currentUser.displayName,
            uid: currentUser.uid,
            text: message,
            timestamp: Date.now(),
          });
          messageInput.value = "";
        } else if (!currentUser) {
          alert("Veuillez vous connecter pour envoyer un message.");
        }
      });

      onChildAdded(sortedMessagesRef, (data) => {
        const msg = data.val();
        const msgEl = document.createElement("div");
        msgEl.classList.add("message");

        const meta = document.createElement("div");
        meta.classList.add("meta");
        meta.textContent = `${msg.user} Â· ${new Date(msg.timestamp).toLocaleTimeString()}`;

        const text = document.createElement("div");
        text.classList.add("text");
        text.textContent = msg.text;

        msgEl.appendChild(meta);
        msgEl.appendChild(text);
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background-color: #f2f2f2;
    }
    #chatBox {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: auto;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .message {
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: #e1f5fe;
      border-left: 4px solid #039be5;
      border-radius: 4px;
    }
    .meta {
      font-size: 0.75rem;
      color: #555;
      margin-bottom: 0.25rem;
    }
    .text {
      font-size: 1rem;
      color: #333;
    }
    input {
      margin: 0.25rem;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #0288d1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0277bd;
    }
    #loginBtn {
      background-color: #34a853;
      margin-bottom: 0.5rem;
    }
    #logoutBtn {
      background-color: #e53935;
      margin-left: 0.5rem;
      margin-bottom: 0.5rem;
      display: none;
    }
    #userInfo {
      margin-bottom: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>ðŸ’¬ Chat en temps rÃ©el - Wassup</h2>
  <button id="loginBtn">Connexion avec Google</button>
  <button id="logoutBtn">DÃ©connexion</button>
  <div id="userInfo">Non connectÃ©</div>
  <div id="chatBox"></div>
  <input type="text" id="message" placeholder="Votre message" disabled />
  <button id="sendBtn" disabled>Envoyer</button>
</body>
</html>
