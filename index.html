<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wassup - Chat en temps rÃ©el</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      onDisconnect,
      onValue,
      set,
      serverTimestamp,
      query,
      orderByChild,
      limitToLast,
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtPmHLghASSnVph2g6YHL5QrIt26DsNlY",
      authDomain: "wassup-b0623.firebaseapp.com",
      databaseURL: "https://wassup-b0623-default-rtdb.firebaseio.com",
      projectId: "wassup-b0623",
      storageBucket: "wassup-b0623.appspot.com",
      messagingSenderId: "967978006384",
      appId: "1:967978006384:web:55b3159139fd729f2741b5",
      measurementId: "G-MFW02K6J1L",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const messagesRef = ref(database, "messages");
    const usersRef = ref(database, "onlineUsers");
    const sortedMessagesRef = query(messagesRef, orderByChild("timestamp"), limitToLast(50));

    document.addEventListener("DOMContentLoaded", () => {
      const chatBox = document.getElementById("chatBox");
      const messageInput = document.getElementById("message");
      const sendBtn = document.getElementById("sendBtn");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const userInfo = document.getElementById("userInfo");
      const errorBox = document.getElementById("errorBox");
      const newMessageBtn = document.getElementById("newMessageBtn");
      const onlineList = document.getElementById("onlineList");

      let currentUser = null;
      let shouldScroll = true;

      chatBox.addEventListener("scroll", () => {
        const nearBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 100;
        shouldScroll = nearBottom;
        newMessageBtn.style.display = nearBottom ? "none" : "block";
      });

      newMessageBtn.addEventListener("click", () => {
        chatBox.scrollTop = chatBox.scrollHeight;
        newMessageBtn.style.display = "none";
      });

      function showError(message) {
        errorBox.textContent = message;
        errorBox.style.display = "block";
        setTimeout(() => (errorBox.style.display = "none"), 5000);
      }

      loginBtn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          currentUser = result.user;
          userInfo.textContent = `ConnectÃ© en tant que ${currentUser.displayName}`;
          logoutBtn.style.display = "inline-block";
          loginBtn.style.display = "none";
          messageInput.disabled = false;
          sendBtn.disabled = false;

          const userStatusRef = ref(database, `onlineUsers/${currentUser.uid}`);
          set(userStatusRef, { name: currentUser.displayName });
          onDisconnect(userStatusRef).remove();
        } catch (error) {
          showError("Erreur de connexion : " + error.message);
          console.error("Erreur Firebase Google Sign-In:", error);
        }
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          const userStatusRef = ref(database, `onlineUsers/${currentUser.uid}`);
          await signOut(auth);
          await set(userStatusRef, null);
          currentUser = null;
          userInfo.textContent = "Non connectÃ©";
          logoutBtn.style.display = "none";
          loginBtn.style.display = "inline-block";
          messageInput.disabled = true;
          sendBtn.disabled = true;
          messageInput.value = "";
        } catch (error) {
          showError("Erreur lors de la dÃ©connexion : " + error.message);
        }
      });

      sendBtn.addEventListener("click", () => {
        const message = messageInput.value.trim();
        if (currentUser && message) {
          push(messagesRef, {
            user: currentUser.displayName,
            uid: currentUser.uid,
            photoURL: currentUser.photoURL || '',
            text: message,
            timestamp: Date.now(),
          });
          messageInput.value = "";
        } else if (!currentUser) {
          showError("Veuillez vous connecter pour envoyer un message.");
        }
      });

      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          sendBtn.click();
        }
      });

      onChildAdded(sortedMessagesRef, (data) => {
        const msg = data.val();
        const msgEl = document.createElement("div");
        msgEl.classList.add("message");

        const avatar = document.createElement("img");
        avatar.classList.add("avatar");
        avatar.src = msg.photoURL || "https://via.placeholder.com/40";
        avatar.alt = msg.user;

        const content = document.createElement("div");
        content.classList.add("messageContent");

        const meta = document.createElement("div");
        meta.classList.add("meta");
        meta.textContent = `${msg.user} Â· ${new Date(msg.timestamp).toLocaleTimeString()}`;

        const text = document.createElement("div");
        text.classList.add("text");
        text.textContent = msg.text;

        content.appendChild(meta);
        content.appendChild(text);

        msgEl.appendChild(avatar);
        msgEl.appendChild(content);
        chatBox.appendChild(msgEl);

        if (shouldScroll) {
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });

      onValue(usersRef, (snapshot) => {
        onlineList.innerHTML = "";
        snapshot.forEach((child) => {
          const user = child.val();
          const li = document.createElement("li");
          li.textContent = user.name;
          onlineList.appendChild(li);
        });
      });
    });
  </script>
  <style>
    #chatBox::-webkit-scrollbar {
      width: 6px;
    }
    #chatBox::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h2>ðŸ’¬ Chat en temps rÃ©el - Wassup</h2>
  <div id="errorBox"></div>
  <button id="loginBtn">Connexion avec Google</button>
  <button id="logoutBtn">DÃ©connexion</button>
  <div id="userInfo">Non connectÃ©</div>
  <ul id="onlineList"></ul>
  <div id="chatBox"></div>
  <button id="newMessageBtn">â†“ Nouveau message</button>
  <input type="text" id="message" placeholder="Votre message" disabled />
  <button id="sendBtn" disabled>Envoyer</button>
</body>
</html>
